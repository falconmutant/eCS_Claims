{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}
  eCS Claims
{% endblock title %}

{% block css %}
  <link type="text/css" href="{% static "css/pnotify.css" %}" rel="stylesheet">
  <style type="text/css">
    #footer {
        padding: 4em 0 6em 0;
        text-align: center;
    }
    #footer .copyright {
        color: #999;
        font-size: 0.9em;
        line-height: 1em;
        margin: 2em 0 0 0;
        padding: 0;
        text-align: center;
    }
    #footer .copyright li {
        display: inline-block;
        list-style: none;
        margin-left: 1em;
        padding-left: 1em;
    }
  </style>
{% endblock css %}

{% block header %}
  <div id="jCrumbs" class="breadCrumb module">
    <ul>
      <li>
        <a href="{{ settings.APP_URL }}/logged_in/"><i class="glyphicon glyphicon-home"></i></a>
      </li>
      <li>
        <a href="">Reportes</a>
      </li>
      <li>
        <a href="">Permisos</a>
      </li>
    </ul>
  </div>
  <div class="row">
    <div class="12u">
      <section class="box">
        <form action="" class="form-horizontal">
          {% csrf_token %}
          <center><h3>Permiso a usuarios</h3></center>
          <hr />
            <div class="form-group">
              <label class="col-md-3 control-label">Usuarios</label>
              <div class="col-xs-4">
                <div class="input-icon">
                  <select onchange="reload(this.value);" name="user" id="user" class="input-error form-control" required>
                    <option></option>
                    <option value="M">MAC</option>
                    <option value="P">PEMEX</option>
                  </Select>
                </div>
              </div>
            </div>
          <hr />
          <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered datatables" id="tabletools">
            <thead>
              <tr>
                <th>Reporte</th>
                <th>Activo</th>
              </tr>
            </thead>
            <tbody id="tb">
              
            </tbody>
          </table>
          <input type="submit" class="btn btn-default" value="Guardar">
        </form>
      </section>
    </div>
  </div>
{% endblock header %}
{% block javascript %}
  <script type="text/javascript" src="{% static "js/pnotify.min.js" %}"></script>
    <script>
      function reload(value){
        $('#tabletools').dataTable().fnDestroy();
        var tag = '';
        if (value == 'P') {
          {% for query in reportes %}
            tag += '<tr>';
            tag += '<td>{{query.title}}</td>';
            tag += '<td><input type="checkbox" id="{{query.id}}';
            tag += 'onchange="permisos({{query.id}},';
            tag += $(#user).val()+')';
            tag += 'name="check"></td>';
            {% for select in PemexPermisos %}
              {% if select.reporte == query.id %}
                selected('{{query.id}}')
              {% endif %}
            {% endfor %}
            tag += '</tr>';
          {% endfor %}
        }
        else{
          {% for query in reportes %}
            tag += '<tr>';
            tag += '<td>{{query.title}}</td>';
            tag += '<td><input type="checkbox" id="{{query.id}}';
            tag += 'onchange="permisos({{query.id}},';
            tag += $(#user).val()+')';
            tag += 'name="check"></td>';
            {% for select in PemexPermisos %}
              {% if select.reporte == query.id %}
                selected('{{query.id}}')
              {% endif %}
            {% endfor %}
            tag += '</tr>';
          {% endfor %}
        }
        $('#tb').html(tag);
        var table3 = $('#tabletools').dataTable({
            "language": {
                "lengthMenu": "_MENU_",
                "sProcessing":     "Procesando...",
                "sZeroRecords":    "No se encontraron resultados",
                "sEmptyTable":     "Ningún dato disponible en esta tabla",
                "sInfo":           "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty":      "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered":   "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix":    "",
                "sUrl":            "",
                "sInfoThousands":  ",",
                "sLoadingRecords": "Cargando...",
                "oPaginate": {
                    "sFirst":    "Primero",
                    "sLast":     "Último",
                    "sNext":     "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            }
        });
        $('.dataTables_filter input').attr('placeholder','Buscar');
        $('#example_length').hide();

        //DOM Manipulation to move datatable elements integrate to panel
        $('.panel-ctrls').append($('.dataTables_filter').addClass("pull-right")).find("label").addClass("panel-ctrls-center");
        $('.panel-ctrls').append("<i class='separator'></i>");
        $('.panel-ctrls').append($('.dataTables_length').addClass("pull-left")).find("label").addClass("panel-ctrls-center");

        $('.dataTables_paginate>ul.pagination').addClass("pull-right m0");
        
      }
      {% if bandera == 1 %}
      $(document).ready(function(){
        new PNotify({
                  title: 'Exito',
                  text: 'El Reporte seleccionado se asigno al usuario con exito!',
                  type: 'success',
                  styling: 'fontawesome'
                });
      });
      {% endif %}
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    function permisos(value1,value2) {
        console.log("create post is working!"); // sanity check
        var c;
        $('#'+value1).change(function(){
            c = this.checked ? 1 : 0;
        })
        $.ajax({
            url : "/permission/", // the endpoint
            type : "POST", // http method
            data : { user : value2,
                     idquery : value1, 
                     selected : c,
                     csrfmiddlewaretoken : csrftoken
                    }, // data sent with the post request

            // handle a successful response
            success : function(json) {
                //$('#check'+value).css('display','none'); // remove the value from the input
                console.log(json); // log the returned json to the console
                console.log("success"); // another sanity check
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };
    </script>
  
{% endblock javascript %}