{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}
  eCS Claims
{% endblock title %}

{% block css %}
  <link type="text/css" href="{% static "css/pnotify.css" %}" rel="stylesheet">
  <style type="text/css">
    #footer {
        padding: 4em 0 6em 0;
        text-align: center;
    }
    #footer .copyright {
        color: #999;
        font-size: 0.9em;
        line-height: 1em;
        margin: 2em 0 0 0;
        padding: 0;
        text-align: center;
    }
    #footer .copyright li {
        display: inline-block;
        list-style: none;
        margin-left: 1em;
        padding-left: 1em;
    }
  </style>
{% endblock css %}

{% block header %}
  <div id="jCrumbs" class="breadCrumb module">
    <ul>
      <li>
        <a href="{{ settings.APP_URL }}/logged_in/"><i class="glyphicon glyphicon-home"></i></a>
      </li>
      <li>
        <a href="">Reportes</a>
      </li>
      <li>
        <a href="">Permisos</a>
      </li>
    </ul>
  </div>
  <div class="row">
    <div class="12u">
      <section class="box">
        <center><h3>Permiso a usuarios</h3></center>
        <hr />
        <form action="" class="form-horizontal" method="POST">{% csrf_token %}
          <div class="form-group">
              <label class="col-md-3 control-label">Usuarios</label>
              <div class="col-xs-4">
                <div class="input-icon">
                  <select onchange="this.form.submit()" name="user" id="user" class="input-error form-control" required>
                    <option></option>
                    {% for user in usuarios %}
                      <option value="{{user.id}}">{{user.username}}</option>
                    {% endfor %}
                  </Select>
                </div>
              </div>
          </div>
        </form>
        <hr />
        <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered datatables" id="tabletools">
          <thead>
            <tr>
              <th>Reporte</th>
              <th>Activo</th>
            </tr>
          </thead>
          <tbody id="tb">
            {% for query in reportes %}
              <tr>
                <td>{{query.title}}</td>
                <td><input type="checkbox" id="{{query.id}}" onchange="permisos({{query.id}},{{value.id}});" name="check"></td>
                {% for select in permisos %}
                  {% if select.reporte == query.id %}
                    <script>
                      selected('{{query.id}}');
                    </script>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </div>
  </div>
{% endblock header %}
{% block javascript %}
  <script type="text/javascript" src="{% static "js/pnotify.min.js" %}"></script>
  {% if bandera == 1 %}
    <script>
      $(document).ready(function(){
        
      });
    </script>
  {% endif %}
  <script type="text/javascript">
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function selected(value){
      $('#'+value).attr("checked", "checked");
    }
    var csrftoken = getCookie('csrftoken');
    function permisos(value,value2) {
        console.log("create post is working!") // sanity check
        $.ajax({
            url : "/cargar_permisos/", // the endpoint
            type : "POST", // http method
            data : { usuario : value2,
                     reporte : value,
                     csrfmiddlewaretoken : csrftoken
                    }, // data sent with the post request

            // handle a successful response
            success : function(json) {
                //$('#check'+value).css('display','none'); // remove the value from the input
                console.log(json); // log the returned json to the console
                new PNotify({
                  title: 'Exito',
                  text: 'El Reporte seleccionado se asigno al usuario con exito!',
                  type: 'success',
                  styling: 'fontawesome'
                });
                console.log("success"); // another sanity check
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };
  </script>
{% endblock javascript %}