{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}
  eCS Claims
{% endblock title %}

{% block css %}
  <link type="text/css" href="{% static "css/pnotify.css" %}" rel="stylesheet">
  <style type="text/css">
    #footer {
        padding: 4em 0 6em 0;
        text-align: center;
    }
    #footer .copyright {
        color: #999;
        font-size: 0.9em;
        line-height: 1em;
        margin: 2em 0 0 0;
        padding: 0;
        text-align: center;
    }
    #footer .copyright li {
        display: inline-block;
        list-style: none;
        margin-left: 1em;
        padding-left: 1em;
    }
  </style>
{% endblock css %}

{% block header %}
  <div id="jCrumbs" class="breadCrumb module">
    <ul>
      <li>
        <a href="{{ settings.APP_URL }}/logged_in/"><i class="glyphicon glyphicon-home"></i></a>
      </li>
      <li>
        <a href="">Reportes</a>
      </li>
      <li>
        <a href="">Permisos</a>
      </li>
    </ul>
  </div>
  <div class="row">
    <div class="12u">
      <section class="box">
        <form action="" class="form-horizontal">
          {% csrf_token %}
          <center><h3>Permiso a usuarios</h3></center>
          <hr />
            <div class="form-group">
              <label class="col-md-3 control-label">Usuarios</label>
              <div class="col-xs-4">
                <div class="input-icon">
                  <select onchange="reload(this.value);" name="user" id="user" class="input-error form-control" required>
                    <option></option>
                    <option value="M">MAC</option>
                    <option value="P">PEMEX</option>
                  </Select>
                </div>
              </div>
            </div>
          <hr />
          <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered datatables" id="tabletools">
            <thead>
              <tr>
                <th>Reporte</th>
                <th>Activo</th>
              </tr>
            </thead>
            <tbody id="tb">
              
            </tbody>
          </table>
          <input type="submit" class="btn btn-default" value="Guardar">
        </form>
      </section>
    </div>
  </div>
{% endblock header %}
{% block javascript %}
  <script type="text/javascript" src="{% static "js/pnotify.min.js" %}"></script>
  {% if bandera == 1 %}
    <script>
      function reload(value){
        if (value == 'P') {
          $('#tb').append('{% for query in reportes %}'+
                '<tr>'+
                  '<td>{{query.title}}</td>'+
                  '<td><input type="checkbox" id="{{query.id}}"'+ 
                  'onchange="permisos({{query.id}},"$(#user).val()");"'+
                  'name="check"></td>'+
                  '{% for select in PemexPermisos %}'+
                    '{% if select.reporte == query.id %}'+
                      '<script>'+
                        "selected('{{query.id}}');"+
                      '</script>'+
                    '{% endif %}'+
                  '{% endfor %}'+
                '</tr>'+
              '{% endfor %}');
        }
        else{
          $('#tb').append('{% for query in reportes %}'+
                '<tr>'+
                  '<td>{{query.title}}</td>'+
                  '<td><input type="checkbox" id="{{query.id}}"'+ 
                  'onchange="permisos({{query.id}},"$(#user).val()");"'+
                  'name="check"></td>'+
                  '{% for select in MacPermisos %}'+
                    '{% if select.reporte == query.id %}'+
                      '<script>'+
                        "selected('{{query.id}}');"+
                      '</script>'+
                    '{% endif %}'+
                  '{% endfor %}'+
                '</tr>'+
              '{% endfor %}');
        }
        
      }
      $(document).ready(function(){
        new PNotify({
                  title: 'Exito',
                  text: 'El Reporte seleccionado se asigno al usuario con exito!',
                  type: 'success',
                  styling: 'fontawesome'
                });
      });
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    function permisos(value1,value2) {
        console.log("create post is working!") // sanity check
        var c
        $('#'+value1).change(function(){
            c = this.checked ? 1 : 0;
        });
        $.ajax({
            url : "/permission/", // the endpoint
            type : "POST", // http method
            data : { user : value2,
                     idquery : value1, 
                     selected : c,
                     csrfmiddlewaretoken : csrftoken
                    }, // data sent with the post request

            // handle a successful response
            success : function(json) {
                //$('#check'+value).css('display','none'); // remove the value from the input
                console.log(json); // log the returned json to the console
                console.log("success"); // another sanity check
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };
    </script>
  {% endif %}
{% endblock javascript %}