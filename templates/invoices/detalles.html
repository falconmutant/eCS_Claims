{% extends 'base.html' %}

{% block title %}
  eCS Claims
{% endblock title %}

{% block css %}
  <style type="text/css">
    #footer {
        padding: 4em 0 6em 0;
        text-align: center;
    }
    #footer .copyright {
        color: #999;
        font-size: 0.9em;
        line-height: 1em;
        margin: 2em 0 0 0;
        padding: 0;
        text-align: center;
    }
    #footer .copyright li {
        display: inline-block;
        list-style: none;
        margin-left: 1em;
        padding-left: 1em;
    }
    .a-details,.a-details:hover{
      font-size: 30px;
      margin-left: 80%;
      border: none !important;
    }
  </style>
{% endblock css %}

{% block header %}
  <div id="jCrumbs" class="breadCrumb module">
    <ul>
      <li>
        <a href="{{ settings.APP_URL }}/logged_in/"><i class="glyphicon glyphicon-home"></i></a>
      </li>
      <li>
        <a href="">Facturas</a>
    </li>
    <li>
        <a href="{{ settings.APP_URL }}/invoice/">Pendientes</a>
    </li>
    <li>
        <a href="">Detalles</a>
    </li>
    </ul>
  </div>
  <div class="row">
    <div class="12u">
      <section class="box">
        <a class="a-details" href="{{ settings.APP_URL }}/invoice/"><i class="fa fa-long-arrow-left"></i></a>
        <a style="margin-left:50px !important;" class="a-details" id="info-claims"><i class="fa fa-info"></i></a>
        <a style="margin-left:50px !important;" class="a-details" id="level"><i class="fa fa-check-square-o"></i></a>
        <h3>Emisor</h3>
        <hr />
        <form id="form" class="form-horizontal">
          <div class="form-group">
            <label class="col-md-2 control-label">Proveedor</label>
            <div class="col-xs-8">
              <div class="input-icon">
                <input class="input-error form-control" type="text" value="{{emisor.nombre}}" disabled>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-2 control-label">RFC</label>
            <div class="col-xs-3">
              <div class="input-icon">
                <input class="input-error form-control" type="text" value="{{emisor.rfc}}" disabled>
              </div>
            </div>
            <label class="col-md-2 control-label">Folio</label>
            <div class="col-xs-3">
              <div class="input-icon">
                <input class="input-error form-control" type="text" value="{{detalle.folio}}" disabled>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-2 control-label">Fecha</label>
            <div class="col-xs-3">
              <div class="input-icon">
                <input class="input-error form-control" type="text" value="{{detalle.fecha}}" disabled>
              </div>
            </div>
            <label class="col-md-2 control-label">Total de Factura</label>
            <div class="col-xs-3">
              <div class="input-icon">
                <input class="input-error form-control" type="text" value="{{detalle.total}}" disabled>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-2 control-label">Impuesto</label>
            <div class="col-xs-3">
              <div class="input-icon">
                <input class="input-error form-control" type="text" value="{{tax.importe}}" disabled>
              </div>
            </div>
          </div>
        </form>
        <hr>
        <h3 style="position:absolute;z-index:2;">Detalles</h3>
        <button style="margin-left:95%;margin-bottom:0px;" data-toggle="collapse" data-target="#demo" type="submit"><i class="fa fa-chevron-down"></i></button>
        <hr>
        <div id="demo" class="collapse">
          <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered datatables" id="tabletools">
            <thead>
              <tr>
                <th>Cantidad</th>
                <th>Unidad</th>
                <th>Descripción</th>
                <th>Importe</th>
              </tr>
            </thead>
            <tbody>
              {% for co in conceptos %}
                <tr>
                  <td>{{co.cantidad}}</td>
                  <td>{{co.unidad}}</td>
                  <td>{{co.descripcion}}</td>
                  <td>{{co.importe}}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <h3 style="position:absolute;z-index:2;">Eventos</h3>
        <button style="margin-left:95%;margin-bottom:0px;" data-toggle="collapse" data-target="#demo2" type="submit"><i class="fa fa-chevron-down"></i></button>
        <hr />
        <div id="demo2" class="collapse">
          <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered datatables" id="tabletools2">
            <thead>
              <tr>
                <th>Evento</th>
                <th>Folio Autorizacion</th>
                <th>Paciente</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for CompEvent in CE %}
                {% for event in fullevento %}
                  {% if event.id == CompEvent.evento %}
                    <tr>
                      <td>{{event.numEvento}}</td>
                      <td>{{event.folioAut}}</td>
                      {% for pac in paciente %}
                        {% if pac.evento_id == event.id %}
                          <td>{{pac.nombre}}</td>
                        {% endif %}
                      {% endfor %}
                      <td></td>
                      <td>{{event.total}}</td>
                    </tr>
                  {% endif %}
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
{% endblock header %}

{% block javascript %}
  <script>
    $(document).ready(function() {
        console.log('{{bug}}');
        console.log('{{bugerror}}');
        var table2 = $('#tabletools2').dataTable({
            "language": {
                "lengthMenu": "_MENU_",
                "sProcessing":     "Procesando...",
                "sZeroRecords":    "No se encontraron resultados",
                "sEmptyTable":     "Ningún dato disponible en esta tabla",
                "sInfo":           "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty":      "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered":   "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix":    "",
                "sUrl":            "",
                "sInfoThousands":  ",",
                "sLoadingRecords": "Cargando...",
                "oPaginate": {
                    "sFirst":    "Primero",
                    "sLast":     "Último",
                    "sNext":     "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            }
        });
        var table3 = $('#tabletools3').dataTable({
            "language": {
                "lengthMenu": "_MENU_",
                "sProcessing":     "Procesando...",
                "sZeroRecords":    "No se encontraron resultados",
                "sEmptyTable":     "Ningún dato disponible en esta tabla",
                "sInfo":           "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty":      "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered":   "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix":    "",
                "sUrl":            "",
                "sInfoThousands":  ",",
                "sLoadingRecords": "Cargando...",
                "oPaginate": {
                    "sFirst":    "Primero",
                    "sLast":     "Último",
                    "sNext":     "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            }
        });
        $('.dataTables_filter input').attr('placeholder','Buscar');
        $('#example_length').hide();

        //DOM Manipulation to move datatable elements integrate to panel
        $('.panel-ctrls').append($('.dataTables_filter').addClass("pull-right")).find("label").addClass("panel-ctrls-center");
        $('.panel-ctrls').append("<i class='separator'></i>");
        $('.panel-ctrls').append($('.dataTables_length').addClass("pull-left")).find("label").addClass("panel-ctrls-center");

        $('.dataTables_paginate>ul.pagination').addClass("pull-right m0");

    });
    $('#level').on('click',function(){
      $('#modal-level').modal('show'); 
    });
    $('#modal').on('click',function(){

      $('#modal-form').modal('show'); 
    });
    $('#info-claims').on('click',function(){
      $('#modal-info').modal('show'); 
    });
    function motivos(value){
      if(value == 'X'){
        $('#motivo').css('display','block');
      }
      else{
        if(value == 'N'){
          $('#motivo').css('display','block');
        }
        else{
          $('#motivo').css('display','none');
        }
      }
    }
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    function create_post(value,comp) {
        console.log("create post is working!") // sanity check
        $.ajax({
            url : "/ligar/", // the endpoint
            type : "POST", // http method
            data : { evento : value,
                     comprobante : comp, 
                     csrfmiddlewaretoken : csrftoken
                    }, // data sent with the post request

            // handle a successful response
            success : function(json) {
                //$('#check'+value).css('display','none'); // remove the value from the input
                console.log(json); // log the returned json to the console
                console.log("success"); // another sanity check
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };
  </script>
{% endblock javascript %}

{% block modal %}
  <div class="modal fade" id="modal-level" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" style="z-index:2000;">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Selecciona Nivel de la Factura</h4>
        </div>
        <form action="" class="form-horizontal" method="POST">{% csrf_token %}
        <div class="modal-body">
            <div class="form-group">
               <div class="form-group">
                <div class="col-xs-6">
                  <div class="input-icon">
                      <select onchange="motivos(this.value);" name="estatus" class="form-control">
                        <option value="1">1er Nivel</option>
                        <option value="2">2do Nivel</option>
                        <option value="3">3er Nivel</option>
                      </select>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <div id="btnmodal" class="modal-footer">
          <button type="button" class="btn btn-default" id="modal" data-dismiss="modal">Cancelar</button>
        </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="modal-form" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" style="z-index:2000;width:90%;">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Autorizar</h4>
        </div>
        <form action="" class="form-horizontal" method="POST">{% csrf_token %}
        <div class="modal-body">
            <div class="form-group">
               <div class="form-group">
                <label class="col-md-2 control-label">Tipo</label>
                <div class="col-xs-6">
                  <div class="input-icon">
                    {% if tipouser.tipo == 'M' %}
                      <select onchange="motivos(this.value);" name="estatus" class="form-control">
                        <option value="Y">Aceptado</option>
                        <option value="N">Rechazado</option>
                        <option value="E">En Revisión</option>
                      </select>
                    {% endif %}
                    {% if tipouser.tipo == 'P' %}
                      <select onchange="motivos(this.value);" name="estatus" class="form-control">
                        <option value="A">Aceptado</option>
                        <option value="X">Rechazado</option>
                        <option value="P">En Revisión</option>
                      </select>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div style="display:none;" id="motivo" class="form-group">
                <label class="col-md-2 control-label">Motivo</label>
                <div class="col-xs-6">
                  <div class="input-icon">
                    <select name="motivo" class="form-control">
                      <option value=""></option>
                      {% for item in motivo %}
                        <option value="{{item.id}}">{{item.motivo}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="col-md-2 control-label">Comentarios</label>
                <div class="col-xs-6">
                  <div class="input-icon">
                    <textarea name="descripcion" class="form-control" rows="6" cols="100"></textarea>
                  </div>
                </div>
              </div>
            </div>
            <input type="hidden" name="id" value="{{idd}}">
        </div>
        <div id="btnmodal" class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
          <input type="submit" class="btn btn-default" value="Actualizar">
        </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="modal-info" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" style="z-index:2000;width:90%;">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Reclamos</h4>
        </div>
        <div class="modal-body">
          <form action="" class="form-horizontal">
          <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered datatables" id="tabletools3">
                  <thead>
                    <tr>
                      <th>Evento</th>
                      <th>Folio Autorización</th>
                      <th>Paciente</th>
                      <th>Tipo</th>
                      <th>Total</th>
                      <th>Ligar</th>
                    </tr>
                  </thead>
                  <tbody id="tb">
                    {% for dato in autorizacion %}
                      {% for event in evento %}
                        {% if event.id == dato.evento_id %}
                          <tr>
                            <td>{{event.numEvento}}</td>
                            <td>{{event.folioAut}}</td>

                            {% for pa in paciente %}
                              {% if pa.evento_id == event.id %}
                                <td>{{pa.nombre}}</td>
                              {% endif %}
                            {% endfor %}
                            
                            <td>{{event.get_tipo_display}}</td>
                            <td>{{event.total}}</td>
                            <td><input type="checkbox" onchange="create_post({{event.id}},{{detalle.id}});" name="check"></td>
                          </tr>
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                  </tbody>
          </table>
          <div id="btnmodal" class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
            <input type="submit" class="btn btn-default" value="Actualizar">
          </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock modal %}